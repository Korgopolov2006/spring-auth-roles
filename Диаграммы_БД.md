# ДИАГРАММЫ БАЗЫ ДАННЫХ - МАГАЗИН ЭЛЕКТРОНИКИ TECHSTORE

## 1. ЛОГИЧЕСКАЯ (ИНФОЛОГИЧЕСКАЯ) ДИАГРАММА

### 1.1. Основные сущности и их атрибуты

#### ПОЛЬЗОВАТЕЛИ
- **ModelUser** (Пользователь)
  - id_user (PK) - Уникальный идентификатор
  - username - Имя пользователя (уникальное)
  - password - Зашифрованный пароль
  - active - Статус активности

- **RoleEnum** (Роль)
  - USER - Обычный пользователь
  - MODERATOR - Модератор
  - ADMIN - Администратор

#### КАТАЛОГ ТОВАРОВ
- **Category** (Категория)
  - id (PK) - Уникальный идентификатор
  - name - Название категории
  - description - Описание категории
  - parent_id (FK) - Ссылка на родительскую категорию
  - is_active - Статус активности
  - created_at - Дата создания

- **Manufacturer** (Производитель)
  - id (PK) - Уникальный идентификатор
  - name - Название производителя
  - country - Страна
  - website - Веб-сайт
  - description - Описание
  - logo_url - URL логотипа
  - is_active - Статус активности
  - created_at - Дата создания

- **Product** (Товар)
  - id (PK) - Уникальный идентификатор
  - name - Название товара
  - description - Описание товара
  - price - Цена
  - old_price - Старая цена (для скидок)
  - sku - Артикул товара
  - category_id (FK) - Ссылка на категорию
  - manufacturer_id (FK) - Ссылка на производителя
  - stock_quantity - Количество на складе
  - min_stock_level - Минимальный уровень запаса
  - weight - Вес
  - dimensions - Размеры
  - warranty_months - Гарантия в месяцах
  - is_active - Статус активности
  - is_featured - Рекомендуемый товар
  - created_at - Дата создания
  - updated_at - Дата обновления

- **ProductImage** (Изображение товара)
  - id (PK) - Уникальный идентификатор
  - product_id (FK) - Ссылка на товар
  - image_url - URL изображения
  - alt_text - Альтернативный текст
  - is_primary - Основное изображение
  - sort_order - Порядок сортировки
  - created_at - Дата создания

- **ProductSpecification** (Характеристика товара)
  - id (PK) - Уникальный идентификатор
  - product_id (FK) - Ссылка на товар
  - spec_name - Название характеристики
  - spec_value - Значение характеристики
  - spec_unit - Единица измерения
  - sort_order - Порядок сортировки
  - created_at - Дата создания

#### ЗАКАЗЫ И ПОКУПКИ
- **Order** (Заказ)
  - id (PK) - Уникальный идентификатор
  - user_id (FK) - Ссылка на пользователя
  - order_number - Номер заказа
  - status - Статус заказа
  - total_amount - Общая сумма
  - shipping_cost - Стоимость доставки
  - tax_amount - Сумма налога
  - discount_amount - Сумма скидки
  - payment_method - Способ оплаты
  - payment_status - Статус оплаты
  - shipping_address - Адрес доставки
  - billing_address - Адрес выставления счета
  - notes - Примечания
  - created_at - Дата создания
  - updated_at - Дата обновления

- **OrderItem** (Элемент заказа)
  - id (PK) - Уникальный идентификатор
  - order_id (FK) - Ссылка на заказ
  - product_id (FK) - Ссылка на товар
  - product_name - Название товара на момент заказа
  - product_sku - Артикул товара на момент заказа
  - quantity - Количество
  - unit_price - Цена за единицу
  - total_price - Общая цена
  - created_at - Дата создания

- **CartItem** (Элемент корзины)
  - id (PK) - Уникальный идентификатор
  - user_id (FK) - Ссылка на пользователя
  - product_id (FK) - Ссылка на товар
  - quantity - Количество
  - added_at - Дата добавления
  - updated_at - Дата обновления

#### ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ
- **ProductReview** (Отзыв о товаре)
  - id (PK) - Уникальный идентификатор
  - product_id (FK) - Ссылка на товар
  - user_id (FK) - Ссылка на пользователя
  - rating - Рейтинг (1-5)
  - title - Заголовок отзыва
  - comment - Текст отзыва
  - is_verified_purchase - Подтвержденная покупка
  - is_approved - Одобрен модератором
  - created_at - Дата создания
  - updated_at - Дата обновления

- **Coupon** (Купон)
  - id (PK) - Уникальный идентификатор
  - code - Код купона
  - name - Название купона
  - description - Описание
  - discount_type - Тип скидки (PERCENTAGE, FIXED_AMOUNT)
  - discount_value - Значение скидки
  - min_order_amount - Минимальная сумма заказа
  - max_discount_amount - Максимальная сумма скидки
  - usage_limit - Лимит использований
  - used_count - Количество использований
  - is_active - Статус активности
  - valid_from - Действует с
  - valid_until - Действует до
  - created_at - Дата создания

- **UserActivityLog** (Лог активности пользователей)
  - id (PK) - Уникальный идентификатор
  - user_id (FK) - Ссылка на пользователя
  - action - Действие
  - entity_type - Тип сущности
  - entity_id - ID сущности
  - details - Детали (JSON)
  - ip_address - IP адрес
  - user_agent - User Agent
  - created_at - Дата создания

- **SystemSettings** (Настройки системы)
  - id (PK) - Уникальный идентификатор
  - setting_key - Ключ настройки
  - setting_value - Значение настройки
  - setting_type - Тип настройки
  - description - Описание
  - is_public - Публичная настройка
  - updated_by (FK) - Обновлено пользователем
  - updated_at - Дата обновления

### 1.2. Связи между сущностями

#### ОСНОВНЫЕ СВЯЗИ:
1. **ModelUser** ↔ **RoleEnum** (Many-to-Many через user_role)
2. **Category** ↔ **Category** (Self-reference для иерархии)
3. **Product** → **Category** (Many-to-One)
4. **Product** → **Manufacturer** (Many-to-One)
5. **Product** ↔ **ProductImage** (One-to-Many)
6. **Product** ↔ **ProductSpecification** (One-to-Many)
7. **Product** ↔ **ProductReview** (One-to-Many)
8. **ModelUser** ↔ **ProductReview** (One-to-Many)
9. **ModelUser** ↔ **Order** (One-to-Many)
10. **Order** ↔ **OrderItem** (One-to-Many)
11. **Product** ↔ **OrderItem** (One-to-Many)
12. **ModelUser** ↔ **CartItem** (One-to-Many)
13. **Product** ↔ **CartItem** (One-to-Many)
14. **ModelUser** ↔ **UserActivityLog** (One-to-Many)

## 2. ФИЗИЧЕСКАЯ (ДАТАЛОГИЧЕСКАЯ) ДИАГРАММА

### 2.1. Таблицы базы данных

#### ТАБЛИЦА: model_user
```sql
CREATE TABLE model_user (
    id_user BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    active BOOLEAN DEFAULT true
);
```

#### ТАБЛИЦА: user_role
```sql
CREATE TABLE user_role (
    user_id BIGINT NOT NULL,
    roles VARCHAR(20) NOT NULL,
    PRIMARY KEY (user_id, roles),
    FOREIGN KEY (user_id) REFERENCES model_user(id_user) ON DELETE CASCADE
);
```

#### ТАБЛИЦА: categories
```sql
CREATE TABLE categories (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    parent_id BIGINT REFERENCES categories(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: manufacturers
```sql
CREATE TABLE manufacturers (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    country VARCHAR(50),
    website VARCHAR(255),
    description TEXT,
    logo_url VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: products
```sql
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    old_price DECIMAL(10,2),
    sku VARCHAR(100) UNIQUE,
    category_id BIGINT REFERENCES categories(id),
    manufacturer_id BIGINT REFERENCES manufacturers(id),
    stock_quantity INTEGER DEFAULT 0,
    min_stock_level INTEGER DEFAULT 5,
    weight DECIMAL(8,2),
    dimensions VARCHAR(50),
    warranty_months INTEGER,
    is_active BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: product_images
```sql
CREATE TABLE product_images (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    image_url VARCHAR(255) NOT NULL,
    alt_text VARCHAR(255),
    is_primary BOOLEAN DEFAULT false,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: product_specifications
```sql
CREATE TABLE product_specifications (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    spec_name VARCHAR(100) NOT NULL,
    spec_value VARCHAR(255) NOT NULL,
    spec_unit VARCHAR(20),
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: product_reviews
```sql
CREATE TABLE product_reviews (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    user_id BIGINT REFERENCES model_user(id_user) ON DELETE CASCADE,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    title VARCHAR(255),
    comment TEXT,
    is_verified_purchase BOOLEAN DEFAULT false,
    is_approved BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: cart_items
```sql
CREATE TABLE cart_items (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES model_user(id_user) ON DELETE CASCADE,
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL DEFAULT 1,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, product_id)
);
```

#### ТАБЛИЦА: orders
```sql
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES model_user(id_user),
    order_number VARCHAR(50) UNIQUE NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING',
    total_amount DECIMAL(10,2) NOT NULL,
    shipping_cost DECIMAL(10,2) DEFAULT 0,
    tax_amount DECIMAL(10,2) DEFAULT 0,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    payment_method VARCHAR(50),
    payment_status VARCHAR(20) DEFAULT 'PENDING',
    shipping_address TEXT,
    billing_address TEXT,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: order_items
```sql
CREATE TABLE order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES orders(id) ON DELETE CASCADE,
    product_id BIGINT REFERENCES products(id),
    product_name VARCHAR(255) NOT NULL,
    product_sku VARCHAR(100),
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: coupons
```sql
CREATE TABLE coupons (
    id BIGSERIAL PRIMARY KEY,
    code VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    discount_type VARCHAR(20) NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    min_order_amount DECIMAL(10,2) DEFAULT 0,
    max_discount_amount DECIMAL(10,2),
    usage_limit INTEGER,
    used_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    valid_from TIMESTAMP,
    valid_until TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: user_activity_log
```sql
CREATE TABLE user_activity_log (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES model_user(id_user),
    action VARCHAR(100) NOT NULL,
    entity_type VARCHAR(50),
    entity_id BIGINT,
    details JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ТАБЛИЦА: system_settings
```sql
CREATE TABLE system_settings (
    id BIGSERIAL PRIMARY KEY,
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value TEXT,
    setting_type VARCHAR(20) DEFAULT 'STRING',
    description TEXT,
    is_public BOOLEAN DEFAULT false,
    updated_by BIGINT REFERENCES model_user(id_user),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.2. Индексы для оптимизации

#### ИНДЕКСЫ ДЛЯ ТОВАРОВ:
- `idx_products_category` ON products(category_id)
- `idx_products_manufacturer` ON products(manufacturer_id)
- `idx_products_price` ON products(price)
- `idx_products_active` ON products(is_active)
- `idx_products_featured` ON products(is_featured)

#### ИНДЕКСЫ ДЛЯ ОТЗЫВОВ:
- `idx_reviews_product` ON product_reviews(product_id)
- `idx_reviews_user` ON product_reviews(user_id)
- `idx_reviews_approved` ON product_reviews(is_approved)

#### ИНДЕКСЫ ДЛЯ ЗАКАЗОВ:
- `idx_orders_user` ON orders(user_id)
- `idx_orders_status` ON orders(status)
- `idx_orders_created` ON orders(created_at)

#### ИНДЕКСЫ ДЛЯ КОРЗИНЫ:
- `idx_cart_user` ON cart_items(user_id)

#### ИНДЕКСЫ ДЛЯ АКТИВНОСТИ:
- `idx_activity_user` ON user_activity_log(user_id)
- `idx_activity_created` ON user_activity_log(created_at)

### 2.3. Ограничения целостности

#### ОСНОВНЫЕ ОГРАНИЧЕНИЯ:
1. **Первичные ключи** для всех таблиц
2. **Внешние ключи** для связей между таблицами
3. **Уникальные ограничения** для username, sku, order_number, coupon_code
4. **Проверочные ограничения** для rating (1-5), positive values
5. **Каскадное удаление** для связанных записей
6. **NOT NULL** ограничения для обязательных полей

### 2.4. Триггеры и функции

#### АВТОМАТИЧЕСКИЕ ОБНОВЛЕНИЯ:
- `updated_at` поля обновляются автоматически
- `used_count` в купонах увеличивается при использовании
- `stock_quantity` уменьшается при заказе

#### ВАЛИДАЦИЯ ДАННЫХ:
- Проверка корректности email адресов
- Проверка формата телефонных номеров
- Валидация URL адресов
- Проверка диапазонов значений

## 3. СХЕМА СВЯЗЕЙ (ER-ДИАГРАММА)

```
ModelUser (1) ←→ (M) RoleEnum [через user_role]
    ↓ (1)
    ↓ (M) Order
    ↓ (1) ←→ (M) OrderItem
    ↓ (M) ←→ (1) Product
    ↓ (M) CartItem ←→ (1) Product
    ↓ (M) ProductReview ←→ (1) Product
    ↓ (M) UserActivityLog

Product (M) ←→ (1) Category
Product (M) ←→ (1) Manufacturer
Product (1) ←→ (M) ProductImage
Product (1) ←→ (M) ProductSpecification

Category (1) ←→ (M) Category [self-reference для иерархии]

Coupon (независимая сущность)
SystemSettings (независимая сущность)
```

## 4. ОПТИМИЗАЦИЯ ПРОИЗВОДИТЕЛЬНОСТИ

### 4.1. Стратегии индексирования
- **Составные индексы** для часто используемых комбинаций полей
- **Частичные индексы** для фильтрации по статусам
- **Индексы по выражениям** для вычисляемых полей

### 4.2. Партиционирование
- **По датам** для логов активности
- **По статусам** для заказов
- **По категориям** для товаров

### 4.3. Архивные таблицы
- **Старые заказы** (> 2 лет)
- **Удаленные товары**
- **Неактивные пользователи**

## 5. РЕЗЕРВНОЕ КОПИРОВАНИЕ И ВОССТАНОВЛЕНИЕ

### 5.1. Стратегия бэкапов
- **Ежедневные полные бэкапы**
- **Почасовые инкрементальные бэкапы**
- **Логи транзакций** для point-in-time recovery

### 5.2. Тестирование восстановления
- **Еженедельное тестирование** восстановления
- **Проверка целостности** данных после восстановления
- **Документирование** процедур восстановления
